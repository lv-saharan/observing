{
  "version": 3,
  "sources": ["../src/symbols.js", "../src/proxies.js", "../src/callbacks.js", "../src/handler.js", "../src/index.js", "src/index.js"],
  "sourcesContent": ["export const proxySymbol = Symbol(\"observing-proxy\")\r\nexport const getSymbol = Symbol(\"proxy-get\")\r\nexport const setSymbol = Symbol(\"proxy-set\")\r\nexport const delSymbol = Symbol(\"proxy-del\")\r\nexport const wellKnownSymbols = Object.getOwnPropertyNames(Symbol)\r\n    .map(key => Symbol[key])\r\n    .filter(value => typeof value === 'symbol')", "const proxyMap = new WeakMap()\r\nconst rawMap = new WeakMap()\r\n\r\nexport function getProxy(o) {\r\n    return proxyMap.get(o) ?? {}\r\n}\r\n\r\nexport function setProxy(o, { proxy, handler }) {\r\n    proxyMap.set(o, { proxy, handler })\r\n    rawMap.set(proxy, { raw: o, handler })\r\n}\r\n\r\nexport function getRaw(proxy) {\r\n    return rawMap.get(proxy) ?? {}\r\n}", "const callbackMap = new WeakMap()\r\n\r\nexport function addCallbackSet(cb, set) {\r\n    let arr = callbackMap.get(cb)\r\n    if (arr === undefined) {\r\n        arr = []\r\n        callbackMap.set(cb, arr)\r\n    }\r\n    arr.push(set)\r\n}\r\n\r\nexport function getCallbackSets(cb) {\r\n    return callbackMap.get(cb) ?? []\r\n}", "import { proxySymbol, wellKnownSymbols, getSymbol, setSymbol, delSymbol } from \"./symbols\"\r\nimport { getProxy, setProxy } from \"./proxies\"\r\nimport { addCallbackSet } from \"./callbacks\"\r\n\r\nexport default class Handler {\r\n    #action = getSymbol\r\n    #path\r\n    #callbacks // use Set\r\n    constructor(...callbacks) {\r\n        this.#callbacks = new Set()\r\n        this.addCallbacks(...callbacks)\r\n\r\n    }\r\n    get callbacks() {\r\n        return this.#callbacks\r\n    }\r\n    addCallbacks(...callbacks) {\r\n        callbacks.forEach(cb => {\r\n            if (!this.#callbacks.has(cb)) {\r\n                this.#callbacks.add(cb)\r\n                addCallbackSet(cb, this.#callbacks)\r\n            }\r\n        })\r\n    }\r\n    doCallbacks({ path, oldVal, val }) {\r\n        this.#callbacks.forEach(callback => {\r\n            callback({ path, oldVal, val })\r\n        })\r\n    }\r\n    // construct(target, args) {\r\n    //     return new target(...args);\r\n    // }\r\n    // defineProperty(target, property, descriptor) {\r\n    //     const result = Reflect.defineProperty(target, property, descriptor)\r\n    //     // this.doCallbacks()\r\n    //     return result\r\n    // }\r\n    // has(target, property) {\r\n    //     return Reflect.has(target, property)\r\n    // }\r\n    // ownKeys(target) {\r\n    //     return Reflect.ownKeys(target);\r\n    // }\r\n    deleteProperty(target, property) {\r\n        const result = Reflect.deleteProperty(target, property)\r\n        this.#action = delSymbol\r\n        return result\r\n    }\r\n    get(target, property, receiver) {\r\n        this.#action = getSymbol\r\n        if (property === proxySymbol) {\r\n            return true\r\n        }\r\n        if (property === \"addCallbacks\") {\r\n            return this.addCallbacks.bind(this)\r\n        }\r\n        const result = Reflect.get(target, property, receiver)\r\n        if (typeof property === 'symbol' && wellKnownSymbols.includes(key)) {\r\n            return result\r\n        }\r\n\r\n        if (!this.#path) this.#path = new Set()\r\n        //\u4E0B\u4E00\u6B21\u8BBF\u95EE\u4E4B\u524D\u6E05\u9664\r\n        Promise.resolve().then(() => {\r\n            this.#path = null\r\n        })\r\n        if (target instanceof Array === false) {\r\n            this.#path.add(property)\r\n        }\r\n        if (typeof result === \"object\") {\r\n            let { proxy, handler } = getProxy(result)\r\n            if (proxy === undefined) {\r\n                handler = new Handler(...this.#callbacks)\r\n                proxy = new Proxy(result, handler)\r\n                setProxy(result, { proxy, handler })\r\n            } else {\r\n                handler.addCallbacks(...this.#callbacks)\r\n            }\r\n            handler.#path = this.#path\r\n            return proxy\r\n        }\r\n        return result;\r\n    }\r\n\r\n    set(target, property, value, receiver) {\r\n        const oldVal = Reflect.get(target, property, receiver)\r\n        const result = Reflect.set(target, property, value, receiver)\r\n        if (!(target instanceof Array && property === \"length\" && this.#action !== delSymbol)) {\r\n            if (!this.#path) this.#path = new Set()\r\n            //\u4E0B\u4E00\u6B21\u8BBF\u95EE\u4E4B\u524D\u6E05\u9664\r\n            Promise.resolve().then(() => {\r\n                this.#path = null\r\n            })\r\n            this.#path.add(property)\r\n            this.doCallbacks({ path: [...this.#path], oldVal, val: value })\r\n        }\r\n        this.#action = setSymbol\r\n        return result\r\n    }\r\n}", "import Handler from \"./handler\"\r\nimport { getProxy, setProxy, getRaw } from \"./proxies\"\r\nimport { proxySymbol } from \"./symbols\"\r\nimport { getCallbackSets } from \"./callbacks\"\r\n/**\r\n * observe will create a proxy as observer\r\n * @param {Object} o \r\n * @returns \r\n */\r\nexport function observe(o = {}, ...callbacks) {\r\n    if (typeof o !== \"object\") {\r\n        console.error(\"observe need a object\")\r\n    }\r\n    if (o[proxySymbol] === true) {\r\n        const { handler } = getRaw(o)\r\n        if (handler) {\r\n            handler.addCallbacks(...callbacks)\r\n        }\r\n        return o\r\n    }\r\n\r\n    let { proxy, handler } = getProxy(o)\r\n    if (handler) {\r\n        handler.addCallbacks(...callbacks)\r\n    } else {\r\n        const _handler = new Handler(...callbacks)\r\n        proxy = new Proxy(o, _handler)\r\n        setProxy(o, { proxy, handler: _handler })\r\n    }\r\n    return proxy\r\n}\r\n\r\n\r\nexport function unobserve(o, ...callbacks) {\r\n    if (typeof o === \"function\") {\r\n        callbacks.unshift(o)\r\n    }\r\n    if (callbacks.length === 0) {\r\n        const { handler } = o[proxySymbol] === true ? getRaw(o) : getProxy(o)\r\n        callbacks = (handler && handler.callbacks) ?? []\r\n    }\r\n    callbacks.forEach(cb => {\r\n        const sets = getCallbackSets(cb)\r\n        sets.forEach(set => {\r\n            set.delete(cb)\r\n        })\r\n    })\r\n}", "import { observe, unobserve } from '../../src/index.js'\r\n\r\nlet user = {\r\n    name: \"user\",\r\n    age: 18,\r\n    likes: [\"footboall\", \"video\", \"game\"],\r\n    girlFriend: {\r\n        name: \"sara\",\r\n        age: 17\r\n    }\r\n}\r\n//root observed\r\nconst observedUser = window.observedUser = observe(user, ({ path, oldVal, val }) => {\r\n    console.log(\"user changed\", path, oldVal, val)\r\n})\r\n\r\nconst observedGrilFriend = window.observedGrilFriend = observedUser.girlFriend\r\n\r\nobserve(observedGrilFriend, ({ path, oldVal, val }) => {\r\n    console.log(\"girl friend changed\", path, oldVal, val)\r\n\r\n})\r\n\r\nobservedGrilFriend.addCallbacks(({ path, oldVal, val }) => {\r\n    console.log(\"proxy girl friend changed!!!\", path, oldVal, val)\r\n\r\n})"],
  "mappings": "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",
  "names": ["key", "handler"]
}
